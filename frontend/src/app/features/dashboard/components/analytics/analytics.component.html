<div class="dashboard-container">
  <div class="dashboard-header">
    <div>
      <h1>Analytics</h1>
      <p class="subtitle">View and analyze your nutrition data over time.</p>
    </div>
  </div>
  <div class="filter-buttons">
    <button 
      mat-raised-button 
      [class.active]="selectedFilter === '7days'"
      (click)="loadReport('7days')"
      [disabled]="loading">
      Last 7 Days
    </button>
    <button 
      mat-raised-button 
      [class.active]="selectedFilter === 'month'"
      (click)="loadReport('month')"
      [disabled]="loading">
      Month
    </button>
    <button 
      mat-raised-button 
      [class.active]="selectedFilter === 'halfyear'"
      (click)="loadReport('halfyear')"
      [disabled]="loading">
      Half Year
    </button>
    <button 
      mat-raised-button 
      [class.active]="selectedFilter === 'year'"
      (click)="loadReport('year')"
      [disabled]="loading">
      Year
    </button>
  </div>
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>
  <div *ngIf="!loading && reportData && reportData.anlyses && reportData.anlyses.length > 0" class="dashboard-content">
    <div class="charts-grid">
      <mat-card class="analytics-card chart-card" *ngFor="let metric of chartTypes">
        <div class="card-header">
          <h3>{{ metric.label }}</h3>
        </div>
        <div *ngIf="getHealthWarning(metric.key)" class="health-warning">
          <mat-icon class="warning-icon">warning</mat-icon>
          <span class="warning-text">{{ getHealthWarning(metric.key) }}</span>
        </div>
        <div class="chart-legend" *ngIf="!metric.singleLine">
          <div class="legend-item">
            <div class="legend-line consumed-line" [attr.style]="'background-color: ' + metric.consumedColor"></div>
            <span>Consumed</span>
          </div>
          <div class="legend-item">
            <div class="legend-line norm-line" [attr.style]="'background-color: ' + metric.normColor"></div>
            <span>Norm</span>
          </div>
          <div class="legend-item">
            <svg class="legend-fill-svg" width="20" height="16" viewBox="0 0 20 16">
              <rect width="20" height="16" [attr.fill]="'url(#' + getPatternId(metric.key) + ')'" rx="2"/>
            </svg>
            <span>Deficit</span>
          </div>
          <div class="legend-item">
            <svg class="legend-fill-svg" width="20" height="16" viewBox="0 0 20 16">
              <rect width="20" height="16" [attr.fill]="metric.checkered ? 'url(#' + getCheckeredPatternId(metric.key) + ')' : metric.areaColor" rx="2"/>
            </svg>
            <span>Surplus</span>
          </div>
        </div>
        <div class="chart-container">
          <svg class="line-chart" 
               [attr.viewBox]="'0 0 ' + getLineChartWidth() + ' ' + getLineChartHeight()"
               preserveAspectRatio="xMidYMid meet"
               *ngIf="getChartData(metric.key).length > 0">
            <defs>
              <pattern *ngIf="!metric.checkered" [attr.id]="getPatternId(metric.key)" x="0" y="0" width="12" height="12" patternUnits="userSpaceOnUse">
                <rect width="12" height="12" [attr.fill]="metric.areaColor.replace('0.4', '0.15')"/>
                <circle cx="3" cy="3" r="2" [attr.fill]="metric.consumedColor + '80'"/>
                <circle cx="9" cy="9" r="2" [attr.fill]="metric.consumedColor + '80'"/>
              </pattern>
              <pattern *ngIf="metric.checkered" [attr.id]="getCheckeredPatternId(metric.key)" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse">
                <rect width="8" height="8" fill="#f5f5f5"/>
                <rect x="0" y="0" width="4" height="4" [attr.fill]="metric.consumedColor + '80'"/>
                <rect x="4" y="4" width="4" height="4" [attr.fill]="metric.consumedColor + '80'"/>
              </pattern>
            </defs>
            <g class="y-axis-grid">
              <line 
                *ngFor="let label of getYAxisLabels(metric.key)"
                [attr.x1]="getLineChartPadding().left"
                [attr.y1]="label.y"
                [attr.x2]="getLineChartWidth() - getLineChartPadding().right"
                [attr.y2]="label.y"
                class="grid-line"/>
            </g>
            <line 
              [attr.x1]="getLineChartPadding().left"
              [attr.y1]="getLineChartPadding().top"
              [attr.x2]="getLineChartPadding().left"
              [attr.y2]="getLineChartHeight() - getLineChartPadding().bottom"
              class="y-axis-line"/>
            <g class="y-axis-labels">
              <text 
                *ngFor="let label of getYAxisLabels(metric.key)"
                [attr.x]="getLineChartPadding().left - 10"
                [attr.y]="label.y"
                text-anchor="end"
                dominant-baseline="middle"
                class="axis-label y-axis-label">
                {{ formatValue(label.value, metric.unit) }}
              </text>
            </g>
            <path 
              *ngIf="!metric.singleLine"
              class="area-path deficit-area" 
              [attr.d]="getAreaPaths(metric.key).deficit"
              [attr.fill]="metric.checkered ? 'url(#' + getCheckeredPatternId(metric.key) + ')' : 'url(#' + getPatternId(metric.key) + ')'"
              [attr.style]="getAreaPaths(metric.key).deficit && getAreaPaths(metric.key).deficit.length > 0 ? '' : 'display: none'"/>
            <path 
              *ngIf="!metric.singleLine"
              class="area-path surplus-area" 
              [attr.d]="getAreaPaths(metric.key).surplus"
              [attr.fill]="metric.checkered ? 'url(#' + getCheckeredPatternId(metric.key) + ')' : metric.areaColor"
              [attr.style]="getAreaPaths(metric.key).surplus && getAreaPaths(metric.key).surplus.length > 0 ? '' : 'display: none'"/>
            <path 
              *ngIf="!metric.singleLine"
              class="chart-line norm-line-path" 
              [attr.d]="getLinePath(getChartDataPoints(metric.key).norm)"
              fill="none"
              [attr.stroke]="metric.normColor"
              stroke-width="2"/>
            <path 
              class="chart-line consumed-line-path" 
              [attr.d]="getLinePath(getChartDataPoints(metric.key).consumed)"
              fill="none"
              [attr.stroke]="metric.consumedColor"
              stroke-width="2"/>
            <rect 
              class="hover-area"
              [attr.x]="getLineChartPadding().left"
              [attr.y]="getLineChartPadding().top"
              [attr.width]="getLineChartWidth() - getLineChartPadding().left - getLineChartPadding().right"
              [attr.height]="getLineChartHeight() - getLineChartPadding().top - getLineChartPadding().bottom"
              fill="transparent"
              (mousemove)="onChartHover($event, metric.key)"
              (mouseleave)="hideTooltip()"
              style="cursor: pointer;"/>
            <g *ngFor="let day of getChartData(metric.key); let i = index">
              <circle 
                *ngIf="getChartDataPoints(metric.key).consumed[i]"
                [attr.cx]="getChartDataPoints(metric.key).consumed[i]?.x"
                [attr.cy]="getChartDataPoints(metric.key).consumed[i]?.y"
                r="8"
                [attr.fill]="metric.consumedColor"
                class="data-point"
                [class.hovered]="tooltip && tooltip.visible && tooltip.date === day.date && tooltip.metric === metric.label"
                (mouseenter)="showTooltip($event, metric.key, i)"
                (mouseleave)="hideTooltip()"
                (click)="navigateToDate(day.date)"
                style="cursor: pointer; opacity: 0; transition: opacity 0.2s, r 0.2s; pointer-events: all;"/>
            </g>
            <circle 
              *ngIf="getLastDataPoint(metric.key).consumed"
              [attr.cx]="getLastDataPoint(metric.key).consumed?.x"
              [attr.cy]="getLastDataPoint(metric.key).consumed?.y"
              r="5"
              [attr.fill]="metric.consumedColor"
              class="flashing-dot consumed-dot"/>
            <circle 
              *ngIf="!metric.singleLine && getLastDataPoint(metric.key).norm"
              [attr.cx]="getLastDataPoint(metric.key).norm?.x"
              [attr.cy]="getLastDataPoint(metric.key).norm?.y"
              r="5"
              [attr.fill]="metric.normColor"
              class="flashing-dot norm-dot"/>
            <g class="x-axis-labels">
              <text 
                *ngFor="let day of getChartData(metric.key); let i = index"
                [attr.x]="getChartDataPoints(metric.key).consumed[i]?.x || 0"
                [attr.y]="getLineChartHeight() - getLineChartPadding().bottom + 15"
                text-anchor="middle"
                class="axis-label x-axis-label">
                {{ getDateShortLabel(day.date) }}
              </text>
          </g>
        </svg>
        <div 
          *ngIf="tooltip && tooltip.visible && tooltip.metric === metric.label" 
          class="chart-tooltip"
          [style.left.px]="tooltip.x"
          [style.top.px]="tooltip.y"
          (click)="navigateToDate(tooltip.date)">
          <div class="tooltip-header">{{ tooltip.date | date:'MMM d, y' }}</div>
          <div class="tooltip-content">
            <div class="tooltip-row">
              <span class="tooltip-label">Consumed:</span>
              <span class="tooltip-value">{{ formatValue(tooltip.consumed, tooltip.unit) }} {{ tooltip.unit }}</span>
            </div>
            <div class="tooltip-row" *ngIf="!metric.singleLine">
              <span class="tooltip-label">Norm:</span>
              <span class="tooltip-value">{{ formatValue(tooltip.norm, tooltip.unit) }} {{ tooltip.unit }}</span>
            </div>
          </div>
          <div class="tooltip-footer">Click to view details</div>
        </div>
      </div>
    </mat-card>
  </div>
  </div>
  <div *ngIf="!loading && (!reportData || !reportData.anlyses || reportData.anlyses.length === 0)" class="no-data">
    <p>No data available for the selected period.</p>
  </div>
</div>
